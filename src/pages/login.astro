---
import "../styles/global.css";
import Layout from "../layouts/Layout.astro";
---

<Layout title="TaVue - Connexion">
  <div class="flex justify-center">
    <div class="card w-[500px]">
      <div>
        <h1 class="text-5xl">Connecte-toi !</h1>
        <p>
          Pour enregistrer tes designs personnalisés, consulter ta galerie et
          commander ta paire.
        </p>
      </div>
      <form id="form" class="flex flex-col gap-2 w-full">
        <div class="flex flex-col flex-1">
          <label for="email">Email</label>
          <input
            class="input w-full"
            type="email"
            name="email"
            id="email"
            placeholder="Ton adresse email"
            required
          />
        </div>
        <div class="flex flex-col flex-1">
          <label for="password">Mot de passe</label>
          <input
            class="input w-full"
            type="password"
            name="password"
            id="password"
            placeholder="Ton mot de passe"
            minlength="8"
            required
          />
        </div>
        <a class="text-xs font-light">Mot de passe oublié ?</a>
        <div class="flex gap-2">
          <a href="/signin" class="btn flex-1">Je n'ai pas de compte</a>
          <button type="submit" class="btn flex-1 btn-primary"
            >Se connecter</button
          >
        </div>
        <p id="msg" class="text-center text-red-500 text-sm"></p>
      </form>
      <div class="divider">ou</div>
      <button id="googlelogin">Se connecter avec Google</button>
    </div>
  </div>
</Layout>

<script type="module">
  const msg = document.getElementById("msg");
  const form = document.getElementById("form");
  const googleBtn = document.getElementById("googlelogin");

  form.onsubmit = async (e) => {
    e.preventDefault();
    msg.innerHTML = "";

    try {
      const resp = await fetch("/api/auth", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          action: "login",
          email: form.email.value,
          password: form.password.value,
        }),
      });

      const data = await resp.json();
      if (data.ok) {
        location.href = "/";
      } else {
        msg.innerHTML =
          data.message || "Nous n'avons pas réussi à te connecter";
      }
    } catch (error) {
      console.error(error);
      msg.innerHTML = "Erreur de connexion au serveur";
    }
  };

  googleBtn.onclick = async () => {
    try {
      const resp = await fetch("/api/auth", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ action: "google" }),
      });

      const data = await resp.json();
      if (data.ok) {
        location.href = "/";
      } else {
        msg.innerHTML = data.message || "Échec de connexion Google";
      }
    } catch (error) {
      console.error(error);
      msg.innerHTML = "Erreur de connexion au serveur";
    }
  };
</script>
