---
import "../styles/global.css";
import Layout from "../layouts/Layout.astro";
---

<Layout title="TaVue - Connexion">
  <div class="flex justify-center p-10">
    <div
      class="flex flex-col gap-4 p-4 bg-base-100 rounded-2xl drop-shadow-sm w-[500px]"
    >
      <div>
        <h1 class="text-5xl">Créé ton compte maintenant !</h1>
        <p>
          Pour enregistrer tes designs personnalisés, consulter ta galerie et
          commander ta paire.
        </p>
      </div>
      <form id="signinForm" class="flex flex-col gap-2 w-full">
        <div class="flex gap-4">
          <div class="flex flex-col flex-1">
            <label for="prenom">Prénom</label>
            <input
              class="input w-full"
              type="text"
              name="prenom"
              id="prenom"
              placeholder="Ton prénom"
              required
            />
          </div>
          <div class="flex flex-col flex-1">
            <label for="nom">Nom</label>
            <input
              class="input w-full"
              type="text"
              name="nom"
              id="nom"
              placeholder="Ton nom de famille"
              required
            />
          </div>
        </div>
        <div class="flex flex-col flex-1">
          <label for="email">Email</label>
          <input
            class="input w-full"
            type="email"
            name="email"
            id="email"
            placeholder="Ton adresse email"
            required
          />
        </div>
        <div class="flex flex-col flex-1">
          <label for="password">Mot de passe</label>
          <input
            class="input w-full"
            type="password"
            name="password"
            id="password"
            placeholder="Ton mot de passe"
            minlength="8"
            required
          />
        </div>
        <div class="flex flex-col flex-1">
          <label for="passwordConfirm">Confirme ton mot de passe</label>
          <input
            class="input w-full"
            type="password"
            name="passwordConfirm"
            id="passwordConfirm"
            placeholder="Ton mot de passe"
            minlength="8"
            required
          />
        </div>
        <div class="flex gap-2">
          <a href="/login" class="btn flex-1">J'ai déjà un compte</a>
          <button id="submit" type="submit" class="btn flex-1 btn-primary"
            >Créer mon compte</button
          >
        </div>
        <p id="msg" class="text-center text-red-500 text-sm"></p>
      </form>
      <div class="divider">ou</div>
      <button id="googlelogin">Se connecter avec Google</button>
    </div>
  </div>

  <script type="module">
    import pocketbase from "https://cdn.jsdelivr.net/npm/pocketbase@0.26.2/dist/pocketbase.es.mjs";
    //const pb = new Pocketbase("https://tavue.paolo-vincent.fr/pb/");//
    const pb = new Pocketbase("http://127.0.0.1:8090");

    const form = document.getElementById("signinForm");
    const msg = document.getElementById("msg");
    let message;

    form.onsubmit = async (e) => {
      e.preventDefault();
      const Prenom = form.prenom.value;
      const Nom = form.nom.value;
      const email = form.email.value;
      const password = form.password.value;
      const passwordConfirm = form.passwordConfirm.value;

      if (!(password === passwordConfirm)) {
        message = "Échec de la confirmation du mot de passe";
        msg.textContent = message;
        return;
      } else {
        try {
          message = await pb.collection("users").create({
            Prenom,
            Nom,
            email,
            password,
            passwordConfirm,
          });
          msg.textContent = message;
          message = await authUser(email, password);
          msg.textContent = message;
        } catch (error) {
          console.log(error);
          message = "Nous n'avons pas réussi à créer ton compte";
          if (error.response?.data?.email?.message) {
            message = "Cette adresse email est déjà utilisée";
            msg.textContent = message;
          }
        }
      }

      //auth pocketbase
      async function authUser(email, password) {
        try {
          await pb.collection("users").authWithPassword(email, password);
          document.cookie = `pb_auth = ${pb.authStore.token}; path=/`;
          console.log(document.cookie);
          location.href = "/";
          return;
        } catch (error) {
          console.error(error);
          return "Nous n'avons pas réussi à te connecter";
        }
      }
    };
  </script>
</Layout>
